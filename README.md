[[Менеджер Telegram сессий TeleGate]]

**README.md**

# Сервис управления Telegram-сессиями (Telegram Session Manager API)

Этот проект представляет собой веб-сервис (API) для централизованного управления сессиями Telegram. С его помощью различные приложения или процессы могут запрашивать свободные Telegram-сессии из пула, возвращать их обратно и получать информацию о состоянии пула. Это упрощает одновременное использование множества аккаунтов Telegram, предотвращает конфликты при одновременном использовании одной сессии и учитывает ограничения Telegram (такие как _Flood Wait_).

**Основное назначение:** предоставить единый API для выдачи и возврата Telegram-сессий из пула, тем самым позволяя эффективно распределять нагрузку между несколькими аккаунтами и автоматизировать управление сессиями.

**Основные возможности сервиса:**

- **Выдача свободной сессии:** через API можно получить Telegram-сессию (аккаунт), которая в данный момент не занята и не заблокирована ожиданием (_Flood Wait_).
- **Возврат сессии в пул:** после использования сессии клиент вызывает API для её освобождения, делая сессию снова доступной для других.
- **Отслеживание состояния сессий:** сервис ведёт учёт занятых сессий и тех, которые временно недоступны из-за ограничений (_Flood Wait_). Специальный эндпоинт позволяет получить агрегированную статистику по пулу сессий (сколько всего, свободно, занято, в ожидании и т.д.).
- **Инвалидация проблемных сессий:** при необходимости API позволяет пометить сессию как невыдаваемую (например, если с аккаунтом проблемы или требуется долгий перерыв). Такая сессия исключается из пула до ручного восстановления.
- **Синхронизация сессий:** сервис может синхронизировать базу данных с фактическими файлами сессий на диске. Если добавить новые файлы сессий или удалить существующие, API обновит свои записи (добавит новые сессии в пул или уберёт удалённые).
- **Фоновые задачи:** встроенные механизмы автоматически освобождают "зависшие" сессии (которые были заняты слишком долго) и периодически запускают синхронизацию, чтобы база данных соответствовала актуальному набору файлов сессий.
- **Защита с помощью API-ключа:** доступ ко всем функциям осуществляется через защищённый API (необходим действительный API-ключ в заголовках запросов), что предотвращает несанкционированное использование сервиса.

**Технологии и стек:**

- **FastAPI (Python)** – фреймворк для создания RESTful API. Обеспечивает высокую производительность и удобную маршрутизацию.
- **Uvicorn/Gunicorn** – ASGI-сервер для запуска приложения FastAPI (Uvicorn используется для разработки, Gunicorn + UvicornWorker – для боевого сервера).
- **PostgreSQL** – база данных для хранения информации о сессиях (идентификаторы, имена, флаги занятости, время последнего использования, состояние Flood Wait и пр.). Используется через пул соединений с помощью библиотеки `psycopg2`.
- **Telegram Client Sessions** – сессии Telegram представляют собой файлы (например, создаваемые библиотекой Telethon). Сервис управляет именно такими файлами-сессиями, позволяя нескольким рабочим процессам разделять набор аккаунтов.
- **Python-библиотека для клиента** – в составе проекта имеется клиентская библиотека на Python (см. руководство по использованию), упрощающая интеграцию API с Python-приложениями. Она использует `requests` для взаимодействия с API и обрабатывает особенности (например, ожидание сессии).

**Как API помогает управлять Telegram-сессиями:**

Предположим, у вас есть несколько аккаунтов Telegram (их сессионные файлы хранятся на диске) и вы хотите распределить задачи между ними – например, рассылать сообщения или выполнять другие действия, не превышая лимиты Telegram. Прямое одновременное использование одного аккаунта в нескольких процессах может привести к ошибкам и блокировкам (Telegram не позволяет использовать одну сессию параллельно). Также при слишком частых действиях Telegram может временно ограничить аккаунт (_Flood Wait_), заставив ждать перед следующей активностью.

Данный сервис решает эти проблемы путем централизованного управления сессиями:

- **Единый пул:** Все ваши Telegram-сессии регистрируются в базе данных и хранятся в пуле. Клиентские приложения запрашивают через API свободную сессию вместо того, чтобы напрямую использовать конкретный файл. Сервис гарантирует, что каждую сессию в один момент получит только один клиент.
- **Учёт ограничений:** Если аккаунт попал под ограничение Flood Wait (требуется подождать определённое время), сервис помечает эту сессию как временно недоступную. Запросившему клиенту возвращается информация, через сколько секунд появится свободная сессия. Это позволяет автоматически ждать и не использовать заблокированный аккаунт раньше времени.
- **Освобождение и рециклинг:** Когда клиент завершил работу с аккаунтом, он сообщает об этом сервису (вызывая соответствующий метод API). Сервис помечает сессию свободной, и её могут получить другие задачи. Благодаря этому один и тот же аккаунт может безопасно переиспользоваться разными процессами последовательно.
- **Удаление человеческого фактора:** API-ключи и централизованный сервис устраняют необходимость вручную отслеживать, какой аккаунт сейчас используется. Это предотвращает ситуации, когда сессия остаётся занятой из-за сбоя или забывается – фоновые задачи автоматически освободят её после заданного времени простоя.
- **Масштабируемость:** Добавить новые аккаунты в пул просто – достаточно поместить новый файл сессии в указанную директорию и вызвать синхронизацию (или дождаться автоматической). Сервис зарегистрирует новую сессию в базе, и она станет доступна через API. Аналогично, удаление или отключение аккаунта можно выполнить, удалив файл и синхронизировав данные.

В итоге, **Telegram Session Manager API** помогает безопасно и эффективно управлять множеством Telegram-аккаунтов в параллельных проектах, обеспечивая балансировку нагрузки и соблюдение ограничений платформы.

